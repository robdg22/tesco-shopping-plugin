(()=>{"use strict";const e=Object.assign({},{"app-grid":{platform:"app",layout:"grid",componentId:"460285c805ef3d57d4777ada2d578eb344acfb8a",libraryName:"DDS Shopping native domain library",libraryId:"460285c805ef3d57d4777ada2d578eb344acfb8a"},"app-vertical":{platform:"app",layout:"vertical",componentId:"d32bcf2b8ce4db5afa4b2a718a60c2075009b715",libraryName:"DDS Shopping native domain library",libraryId:"d32bcf2b8ce4db5afa4b2a718a60c2075009b715"},"app-horizontal":{platform:"app",layout:"horizontal",componentId:"004c06075c5e082faaab349559abedfb86229e3a",libraryName:"DDS Shopping native domain library",libraryId:"004c06075c5e082faaab349559abedfb86229e3a"},"mobile-web-grid":{platform:"mobile-web",layout:"grid",componentId:"ca2dca0f0925c9184a3d0d85e5662cf6db83efd9",libraryName:"DDS Shopping web domain library",libraryId:"ca2dca0f0925c9184a3d0d85e5662cf6db83efd9"},"mobile-web-vertical":{platform:"mobile-web",layout:"vertical",componentId:"bfd125dd00b542b4e21d2dfb9980ed5584fc8fb6",libraryName:"DDS Shopping web domain library",libraryId:"bfd125dd00b542b4e21d2dfb9980ed5584fc8fb6"},"mobile-web-horizontal":{platform:"mobile-web",layout:"horizontal",componentId:"8612136a8ee1b7f167ad984028c614c3f5ee139a",libraryName:"DDS Shopping web domain library",libraryId:"8612136a8ee1b7f167ad984028c614c3f5ee139a"},"desktop-web-grid":{platform:"desktop-web",layout:"grid",componentId:"ca2dca0f0925c9184a3d0d85e5662cf6db83efd9",libraryName:"DDS Shopping web domain library",libraryId:"ca2dca0f0925c9184a3d0d85e5662cf6db83efd9"},"desktop-web-vertical":{platform:"desktop-web",layout:"vertical",componentId:"9a1fb3f66e66b08f80969d8d45a97bc7768c68ef",libraryName:"DDS Shopping web domain library",libraryId:"9a1fb3f66e66b08f80969d8d45a97bc7768c68ef"},"desktop-web-horizontal":{platform:"desktop-web",layout:"horizontal",componentId:"8612136a8ee1b7f167ad984028c614c3f5ee139a",libraryName:"DDS Shopping web domain library",libraryId:"8612136a8ee1b7f167ad984028c614c3f5ee139a"}}),t={grid:{layoutMode:"HORIZONTAL",layoutWrap:"WRAP"},vertical:{layoutMode:"VERTICAL",layoutWrap:"NO_WRAP"},horizontal:{layoutMode:"HORIZONTAL",layoutWrap:"NO_WRAP"}};var n=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{c(o.next(e))}catch(e){r(e)}}function s(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((o=o.apply(e,t||[])).next())}))};function o(e){return n(this,arguments,void 0,(function*(e,t={}){const n=yield fetch("https://origin-preview1-mango.omnichannel.tescocloud.com/api",{method:"POST",headers:{"Content-Type":"application/json",Region:"UK"},body:JSON.stringify({query:e,variables:t})});if(!n.ok)throw new Error(`API request failed with status ${n.status}`);return n.json()}))}function i(o,i,s,c,d){return n(this,void 0,void 0,(function*(){const l=e[`${s}-${c}`];if(!l||!l.componentId)throw new Error(`No component configured for ${s} ${c}`);let p;const u=l.componentId.length>20&&/^[a-f0-9]+$/i.test(l.componentId);if(l.libraryId&&l.libraryId.length>0||u)try{console.log("Importing component with key:",l.componentId),p=yield figma.importComponentByKeyAsync(l.componentId)}catch(e){throw new Error(`Failed to import library component: ${l.componentId}. Make sure the library is published and accessible.`)}else{const e=yield figma.getNodeByIdAsync(l.componentId);if(!e||"COMPONENT"!==e.type)throw new Error(`Local component not found: ${l.componentId}`);p=e}yield function(e){return n(this,void 0,void 0,(function*(){const t=new Set;r(e,t);const n=Array.from(t).map((e=>{const[t,n]=e.split(":");return figma.loadFontAsync({family:t,style:n})}));try{yield Promise.all(n),console.log(`Preloaded ${t.size} fonts from component`)}catch(e){console.warn("Some fonts failed to load:",e)}}))}(p);const f=t[c];o.layoutMode=f.layoutMode,o.layoutWrap=f.layoutWrap,o.primaryAxisSizingMode="AUTO",o.counterAxisSizingMode="AUTO",o.itemSpacing=16,o.paddingLeft=16,o.paddingRight=16,o.paddingTop=16,o.paddingBottom=16;const g=i.slice(0,d);let y=0;for(const e of g){const t=p.createInstance();o.appendChild(t),yield a(t,e),y++}figma.ui.postMessage({type:"populateComplete",success:!0,populatedCount:y,totalSelected:y})}))}function r(e,t){if("TEXT"===e.type&&"object"==typeof e.fontName&&null!==e.fontName&&t.add(`${e.fontName.family}:${e.fontName.style}`),"children"in e&&e.children)for(const n of e.children)r(n,t)}function a(e,t){return n(this,void 0,void 0,(function*(){var n,o,i,r,a,l,p,u,f,g,y,m,v,h,b,I,$,w;console.log(`Populating node: ${e.name} with product: ${t.title}`);const S="Rating",M="productRatingText",N="productRatingStars",T="productRating";if(t.title){const n=s(e,"productName");n&&"TEXT"===n.type&&(yield c(n,t.title),n.visible=!0)}if(null===(n=t.price)||void 0===n?void 0:n.price){const n=s(e,"productPrice");if(n&&"TEXT"===n.type){const e=`£${t.price.price.toFixed(2)}`;yield c(n,e),n.visible=!0}}const C=s(e,"productPriceWeight");if(C&&"TEXT"===C.type){const e=(null===(o=t.price)||void 0===o?void 0:o.unitPrice)&&(null===(i=t.price)||void 0===i?void 0:i.unitOfMeasure),n="each"!==(null===(a=null===(r=t.price)||void 0===r?void 0:r.unitOfMeasure)||void 0===a?void 0:a.toLowerCase());if(e&&n){const e=`£${parseFloat(t.price.unitPrice).toFixed(2)}/${t.price.unitOfMeasure}`;yield c(C,e),C.visible=!0,console.log(`Set unit price: ${e}`)}else C.visible=!1,console.log(`Hiding unit price (unitOfMeasure: ${(null===(l=t.price)||void 0===l?void 0:l.unitOfMeasure)||"none"})`)}const P=t.promotions&&t.promotions.length>0,k=s(e,"offerText");k&&"TEXT"===k.type&&(P?(yield c(k,t.promotions[0].offerText||"Special Offer"),k.visible=!0):k.visible=!1);const R=s(e,"valueBar");if(R&&(R.visible=P,console.log(`Value bar visibility: ${P}`)),t.defaultImageUrl||(null===(u=null===(p=t.media)||void 0===p?void 0:p.defaultImage)||void 0===u?void 0:u.url)){const n=t.defaultImageUrl||t.media.defaultImage.url,o=s(e,"productImage");!o||"RECTANGLE"!==o.type&&"FRAME"!==o.type||(yield d(o,n),o.visible=!0)}const A=s(e,"Thumbnail");if(A&&"INSTANCE"===A.type)try{if(t.defaultImageUrl||(null===(g=null===(f=t.media)||void 0===f?void 0:f.defaultImage)||void 0===g?void 0:g.url)){const e=t.defaultImageUrl||t.media.defaultImage.url;yield d(A,e),A.visible=!0}}catch(e){console.log("Could not set thumbnail image:",e)}if((null===(m=null===(y=t.reviews)||void 0===y?void 0:y.stats)||void 0===m?void 0:m.noOfReviews)>0&&void 0!==(null===(h=null===(v=t.reviews)||void 0===v?void 0:v.stats)||void 0===h?void 0:h.overallRating)){const n=t.reviews.stats.overallRating,o=t.reviews.stats.noOfReviews,i=s(e,M);if(i&&"TEXT"===i.type){const e=`${n.toFixed(1)} (${o})`;yield c(i,e),i.visible=!0,console.log(`Set rating text: ${e}`)}const r=s(e,N);if(r&&"INSTANCE"===r.type)try{const e=Math.round(2*n)/2,t=Math.max(0,Math.min(5,e));(null===(b=r.variantProperties)||void 0===b?void 0:b.Stars)&&(r.setProperties({Stars:t.toString()}),console.log(`Set rating stars to: ${t}`)),r.visible=!0}catch(e){console.log("Could not set rating stars variant:",e)}const a=s(e,T)||s(e,S);a&&(a.visible=!0)}else{const t=s(e,M);t&&(t.visible=!1);const n=s(e,N);n&&(n.visible=!1);const o=s(e,T)||s(e,S);o&&(o.visible=!1),console.log("No reviews - hiding rating elements")}const E=!0===t.isNew,D="MPProduct"===t.__typename,F="FNFProduct"===t.__typename,x=E||D||F,O=s(e,"tagNew");if(O){if("INSTANCE"===O.type&&E)try{(null===(I=O.variantProperties)||void 0===I?void 0:I.Type)&&O.setProperties({Type:"New"})}catch(e){console.log("Could not set New tag variant:",e)}O.visible=E,console.log(`New tag visibility: ${E}`)}const L=s(e,"tagMarketplace");if(L){if("INSTANCE"===L.type&&D)try{(null===($=L.variantProperties)||void 0===$?void 0:$.Type)&&L.setProperties({Type:"Marketplace"})}catch(e){console.log("Could not set Marketplace tag variant:",e)}L.visible=D,console.log(`Marketplace tag visibility: ${D}`)}const _=s(e,"tagFnf");if(_){if("INSTANCE"===_.type&&F)try{(null===(w=_.variantProperties)||void 0===w?void 0:w.Type)&&_.setProperties({Type:"F&F"})}catch(e){console.log("Could not set F&F tag variant:",e)}_.visible=F,console.log(`F&F tag visibility: ${F}`)}const q=s(e,"productTags");q&&(q.visible=x,console.log(`Tags container visibility: ${x}`))}))}function s(e,t){if(e.name===t)return e;if("children"in e)for(const n of e.children){const e=s(n,t);if(e)return e}return null}function c(e,t){return n(this,void 0,void 0,(function*(){try{yield figma.loadFontAsync(e.fontName),e.characters=t,console.log(`Set text: "${t}"`)}catch(e){throw console.error("Failed to set text content:",e),e}}))}function d(e,t){return n(this,void 0,void 0,(function*(){try{const n=yield figma.createImageAsync(t);if("RECTANGLE"===e.type||"FRAME"===e.type)e.fills=[{type:"IMAGE",imageHash:n.hash,scaleMode:"FILL"}];else if("INSTANCE"===e.type){const t=s(e,"Image placeholder")||s(e,"productImage");!t||"RECTANGLE"!==t.type&&"FRAME"!==t.type||(t.fills=[{type:"IMAGE",imageHash:n.hash,scaleMode:"FILL"}])}console.log(`Set image: ${t}`)}catch(e){throw console.error("Failed to set image fill:",e),e}}))}figma.showUI(__html__,{width:400,height:600}),figma.ui.onmessage=t=>n(void 0,void 0,void 0,(function*(){console.log("Received message:",t);try{switch(t.type){case"searchProducts":yield function(e){return n(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.query))return void figma.ui.postMessage({type:"error",error:"Search query is required"});try{const t=yield o("\n    query SearchProducts($query: String!, $count: Int, $offset: Int) {\n      search(query: $query, count: $count, offset: $offset) {\n        pageInformation: info {\n          totalCount: total\n          pageNo: page\n          count\n        }\n        productItems: products {\n          id\n          baseProductId\n          title\n          brandName\n          shortDescription\n          defaultImageUrl\n          media {\n            defaultImage {\n              url\n              aspectRatio\n            }\n            images {\n              url\n              aspectRatio\n            }\n          }\n          isNew\n          price {\n            price: actual\n            unitPrice\n            unitOfMeasure\n          }\n          promotions {\n            promotionId: id\n            promotionType\n            startDate\n            endDate\n            offerText: description\n          }\n          reviews {\n            stats {\n              noOfReviews\n              overallRating\n              overallRatingRange\n            }\n          }\n        }\n      }\n    }\n  ",{query:e.query,count:e.count||20,offset:e.offset||0});figma.ui.postMessage({type:"searchProductsResponse",data:t})}catch(e){figma.ui.postMessage({type:"error",error:`Search failed: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(t.payload);break;case"getTaxonomy":yield function(){return n(this,void 0,void 0,(function*(){try{const e=yield o("\n    query TaxonomySuperDepts($storeId: ID, $style: String) {\n      taxonomy(storeId: $storeId) {\n        id\n        name\n        label\n        images(style: $style) {\n          style\n          images {\n            type\n            url\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n    }\n  ",{storeId:"3060",style:"rounded"});if(e.data&&e.data.taxonomy){const t=e.data.taxonomy.filter((e=>"superdepartment"===e.label||"TaxonomyItemType"===e.__typename));figma.ui.postMessage({type:"getTaxonomyResponse",data:Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{taxonomy:t})})})}else figma.ui.postMessage({type:"getTaxonomyResponse",data:e})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load categories: ${e instanceof Error?e.message:"Unknown error"}`})}}))}();break;case"getCategoryProducts":yield function(e){return n(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.categoryId))return void figma.ui.postMessage({type:"error",error:"Category ID is required"});try{const t=yield o("\n    query GetCategoryProducts(\n      $facet: ID\n      $page: Int\n      $count: Int\n      $sortBy: String\n      $offset: Int\n      $superDepartment: String\n      $department: String\n      $aisle: String\n      $shelf: String\n      $offers: Boolean\n      $new: Boolean\n      $favourites: Boolean\n      $brand: String\n      $brands: [String]\n      $dietary: String\n      $categoryId: ID\n      $pageName: String\n    ) {\n      category(\n        page: $page\n        count: $count\n        sortBy: $sortBy\n        offset: $offset\n        facet: $facet\n        superDepartment: $superDepartment\n        department: $department\n        aisle: $aisle\n        shelf: $shelf\n        offers: $offers\n        new: $new\n        favourites: $favourites\n        brand: $brand\n        brands: $brands\n        dietary: $dietary\n        categoryId: $categoryId\n      ) {\n        pageInformation: info {\n          ...PageInformation\n        }\n        productItems: products {\n          ...ProductItem\n        }\n        facetLists: facetGroups {\n          ...FacetLists\n        }\n        options {\n          sortBy\n        }\n      }\n    }\n\n    fragment PageInformation on ListInfoInterface {\n      totalCount: total\n      pageNo: page\n      count\n      pageSize\n      offset\n    }\n\n    fragment ProductItem on ProductInterface {\n      id\n      baseProductId\n      title\n      brandName\n      shortDescription\n      defaultImageUrl\n      media {\n        defaultImage {\n          url\n          aspectRatio\n        }\n        images {\n          url\n          aspectRatio\n        }\n      }\n      badgeDetails(pageName: $pageName) {\n        badges\n        subText\n      }\n      superDepartmentId\n      superDepartmentName\n      departmentId\n      departmentName\n      aisleId\n      aisleName\n      shelfId\n      shelfName\n      displayType\n      productType\n      averageWeight\n      bulkBuyLimit\n      maxQuantityAllowed: bulkBuyLimit\n      groupBulkBuyLimit\n      bulkBuyLimitMessage\n      bulkBuyLimitGroupId\n      timeRestrictedDelivery\n      restrictedDelivery\n      isForSale\n      isNew\n      isRestrictedOrderAmendment\n      status\n      maxWeight\n      minWeight\n      increment\n      catchWeightList {\n        price\n        weight\n        default\n      }\n      restrictedDeliveryTime {\n        day\n        startDateTime\n        endDateTime\n        message\n      }\n      restrictedDeliveryDate {\n        startDate\n        endDate\n        leadTimeValue\n        message\n      }\n      price {\n        price: actual\n        unitPrice\n        unitOfMeasure\n      }\n      promotions {\n        promotionId: id\n        promotionType\n        startDate\n        endDate\n        offerText: description\n      }\n      reviews {\n        stats {\n          noOfReviews\n          overallRating\n          overallRatingRange\n        }\n      }\n    }\n\n    fragment FacetLists on ProductListFacetGroupInterface {\n      categoryId\n      category\n      facets {\n        facetId: id\n        facetName: name\n        binCount: count\n        isSelected: selected\n      }\n    }\n  ",{categoryId:e.categoryId,pageName:"browse",count:e.count||20,offset:e.offset||0});figma.ui.postMessage({type:"getCategoryProductsResponse",data:t})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load category products: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(t.payload);break;case"getCategoryChildren":yield function(e){return n(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.categoryId))return void figma.ui.postMessage({type:"error",error:"Category ID is required"});try{const t=yield o("\n    query GetCategoryChildren($categoryId: String, $storeId: ID) {\n      taxonomy(storeId: $storeId, categoryId: $categoryId) {\n        id\n        name\n        label\n        pageType\n        images {\n          style\n          images {\n            type\n            url\n            __typename\n          }\n          __typename\n        }\n        children {\n          id\n          name\n          label\n          pageType\n          images {\n            style\n            images {\n              type\n              url\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n    }\n  ",{categoryId:e.categoryId,storeId:"3060"});figma.ui.postMessage({type:"getCategoryChildrenResponse",data:t})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load category children: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(t.payload);break;case"searchWithSuggestions":yield function(e){return n(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.query))return void figma.ui.postMessage({type:"error",error:"Search query is required"});try{const t={query:e.query,suggestionsCount:e.suggestionsCount||10};console.log("Making search suggestions request with variables:",t);const n=yield o("\n    query SearchWithSuggestions(\n      $query: String!\n      $suggestionsCount: Int\n      $params: BrowseSearchConfig\n      $configs: [ConfigArgType]\n    ) {\n      search(\n        query: $query\n        config: $params\n        configs: $configs\n      ) {\n        suggestions(suggestionsCount: $suggestionsCount) {\n          searchTerms {\n            suggestionQuery\n          }\n          info {\n            count\n            query\n          }\n        }\n      }\n    }\n  ",t);console.log("Search suggestions API response:",n),figma.ui.postMessage({type:"searchWithSuggestionsResponse",data:n})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to search with suggestions: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(t.payload);break;case"loadRecentSearches":yield function(){return n(this,void 0,void 0,(function*(){try{const e=yield figma.clientStorage.getAsync("tesco-recent-searches");figma.ui.postMessage({type:"recentSearchesLoaded",data:e||[]})}catch(e){console.error("Failed to load recent searches:",e),figma.ui.postMessage({type:"recentSearchesLoaded",data:[]})}}))}();break;case"saveRecentSearches":yield function(e){return n(this,void 0,void 0,(function*(){try{(null==e?void 0:e.searches)&&(yield figma.clientStorage.setAsync("tesco-recent-searches",e.searches),console.log("Recent searches saved:",e.searches))}catch(e){console.error("Failed to save recent searches:",e)}}))}(t.payload);break;case"populateSelectedTiles":yield function(e){return n(this,void 0,void 0,(function*(){var t;if(console.log("Starting population with config:",{platform:null==e?void 0:e.platform,layout:null==e?void 0:e.layout,totalProducts:null===(t=null==e?void 0:e.products)||void 0===t?void 0:t.length,selectedProductIds:null==e?void 0:e.selectedProducts}),!(null==e?void 0:e.products)||0===e.products.length)return void figma.ui.postMessage({type:"error",error:"No products provided"});let o=e.products;if(e.selectedProducts&&e.selectedProducts.length>0&&(o=e.products.filter((t=>e.selectedProducts.includes(t.id))),console.log(`Filtered to ${o.length} selected products from ${e.products.length} total`)),0!==o.length)try{const t=figma.currentPage.selection,s=function(e){const t=[];function n(e){if(function(e){if("FRAME"===e.type||"COMPONENT"===e.type||"INSTANCE"===e.type){const t=e.name.toLowerCase();return t.includes("product")||t.includes("tile")||t.includes("card")||t.includes("item")}if("GROUP"===e.type){const t=e.name.toLowerCase();return t.includes("product")||t.includes("tile")||t.includes("card")||t.includes("item")}return!1}(e)&&(t.push(e),console.log(`Found product tile: ${e.name} (${e.type})`)),"children"in e&&e.children)for(const t of e.children)n(t)}for(const t of e)n(t);return t}(t);s.length>0?yield function(e,t){return n(this,void 0,void 0,(function*(){let n=0;const o=[],i=new Set;for(const t of e)r(t,i);const s=Array.from(i).map((e=>{const[t,n]=e.split(":");return figma.loadFontAsync({family:t,style:n})}));try{yield Promise.all(s),console.log(`Preloaded ${i.size} fonts for existing tiles`)}catch(e){console.warn("Some fonts failed to load:",e)}for(let i=0;i<e.length;i++){const r=i%t.length;try{yield a(e[i],t[r]),n++}catch(e){o.push(`Tile ${i+1}: ${e instanceof Error?e.message:"Unknown error"}`)}}figma.ui.postMessage({type:"populateComplete",success:!0,populatedCount:n,totalSelected:e.length,errors:o.length>0?o:void 0})}))}(s,o):1===t.length&&"FRAME"===t[0].type?yield i(t[0],o,e.platform||"app",e.layout||"grid",o.length):yield function(e,t,o,r){return n(this,void 0,void 0,(function*(){const n=figma.createFrame();n.name=`${t} - ${o} - Product Grid`,n.x=figma.viewport.center.x-200,n.y=figma.viewport.center.y-200,figma.currentPage.appendChild(n),figma.currentPage.selection=[n],yield i(n,e,t,o,r)}))}(o,e.platform||"app",e.layout||"grid",o.length)}catch(e){figma.ui.postMessage({type:"error",error:e instanceof Error?e.message:"Population failed"})}else figma.ui.postMessage({type:"error",error:"No products to populate"})}))}(t.payload);break;case"saveComponentMapping":yield function(){return n(this,void 0,void 0,(function*(){figma.ui.postMessage({type:"error",error:"Component mappings are locked and cannot be modified. Contact your administrator to update default configurations."})}))}(t.payload);break;case"getSelectedComponentId":yield function(){return n(this,void 0,void 0,(function*(){var e,t,n,o;const i=figma.currentPage.selection;if(0===i.length)return void figma.ui.postMessage({type:"error",error:"Please select a component first"});const r=i[0];if("COMPONENT"!==r.type&&"INSTANCE"!==r.type)return void figma.ui.postMessage({type:"error",error:"Please select a component or component instance"});let a,s,c;if("INSTANCE"===r.type){const n=r.mainComponent;if(!n)return void figma.ui.postMessage({type:"error",error:"Could not find main component for instance"});void 0!==n.remote?(a=n.key,s=null===(e=n.remote)||void 0===e?void 0:e.key,c=null===(t=n.remote)||void 0===t?void 0:t.name):(a=n.id,s=void 0,c=void 0)}else void 0!==r.remote?(a=r.key,s=null===(n=r.remote)||void 0===n?void 0:n.key,c=null===(o=r.remote)||void 0===o?void 0:o.name):(a=r.id,s=void 0,c=void 0);figma.ui.postMessage({type:"selectedComponentId",componentId:a,componentName:r.name,libraryId:s,libraryName:c})}))}();break;case"loadComponentMappings":yield function(){return n(this,void 0,void 0,(function*(){try{figma.ui.postMessage({type:"componentMappingsLoaded",mappings:e})}catch(e){console.error("Failed to load component mappings:",e)}}))}();break;case"extractMappings":yield function(){return n(this,void 0,void 0,(function*(){try{const t=figma.currentPage.selection;if(0===t.length)return void figma.ui.postMessage({type:"error",error:'Please select frames to scan for component instances (name them like: "app-grid", "mobile-web-vertical", etc.)'});const o={};let i=0;for(const r of t){if("FRAME"!==r.type)continue;const a=r.name.toLowerCase();function s(t){return n(this,void 0,void 0,(function*(){if(t.children)for(const n of t.children){if("INSTANCE"===n.type)try{const t=yield n.getMainComponentAsync();if(t){let r="",s="",c="Local Components";console.log("Instance info:",{instanceComponentId:n.componentId,mainComponentId:t.id,mainComponentKey:t.key}),t.key?(r=t.key,s=t.key,c="Imported Library"):r=t.id;for(const n in e)if(a.includes(n)||a.includes(n.replace("-"," "))){o[n]={componentId:r,libraryId:s,libraryName:c,componentName:t.name},i++,console.log(`Found mapping for ${n}: ${r} (libraryId: ${s})`);break}}}catch(e){console.warn("Failed to get main component:",e)}"FRAME"===n.type&&(yield s(n))}}))}yield s(r)}if(0===i)return void figma.ui.postMessage({type:"error",error:'No component instances found. Make sure your frames contain component instances and are named like: "app-grid", "mobile-web-vertical", etc.'});figma.ui.postMessage({type:"extractedMappings",mappings:o,foundCount:i})}catch(c){figma.ui.postMessage({type:"error",error:`Failed to extract mappings: ${c instanceof Error?c.message:"Unknown error"}`})}}))}();break;default:figma.ui.postMessage({type:"error",error:"Unknown message type"})}}catch(e){console.error("Plugin error:",e),figma.ui.postMessage({type:"error",error:e instanceof Error?e.message:"Unknown error"})}}))})();