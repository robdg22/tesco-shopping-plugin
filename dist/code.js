(()=>{"use strict";({383:function(){var e=this&&this.__awaiter||function(e,n,t,o){return new(t||(t=Promise))((function(r,a){function s(e){try{c(o.next(e))}catch(e){a(e)}}function i(e){try{c(o.throw(e))}catch(e){a(e)}}function c(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,i)}c((o=o.apply(e,n||[])).next())}))};function n(n){return e(this,arguments,void 0,(function*(e,n={}){const t=yield fetch("https://tesco-proxy-b4fena2ys-robdgraham-gmailcoms-projects.vercel.app/api/tesco",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,variables:n})});if(!t.ok)throw new Error(`API request failed with status ${t.status}`);return t.json()}))}function t(n,t){return e(this,void 0,void 0,(function*(){var e,s,i,c,l;console.log(`Populating node: ${n.name} with product: ${t.title}`);if(t.title){const e=o(n,"productName");e&&"TEXT"===e.type&&(yield r(e,t.title))}if(null===(e=t.price)||void 0===e?void 0:e.price){const e=o(n,"productPrice");if(e&&"TEXT"===e.type){const n=`Â£${t.price.price.toFixed(2)}`;yield r(e,n)}}if(t.promotions&&t.promotions.length>0){const e=o(n,"offerText");e&&"TEXT"===e.type&&(yield r(e,t.promotions[0].offerText||"Special Offer"))}if(t.defaultImageUrl||(null===(i=null===(s=t.media)||void 0===s?void 0:s.defaultImage)||void 0===i?void 0:i.url)){const e=t.defaultImageUrl||t.media.defaultImage.url,r=o(n,"productImage");!r||"RECTANGLE"!==r.type&&"FRAME"!==r.type||(yield a(r,e))}const d=o(n,"Thumbnail");if(d&&"INSTANCE"===d.type)try{if(t.defaultImageUrl||(null===(l=null===(c=t.media)||void 0===c?void 0:c.defaultImage)||void 0===l?void 0:l.url)){const e=t.defaultImageUrl||t.media.defaultImage.url;yield a(d,e)}}catch(e){console.log("Could not set thumbnail image:",e)}}))}function o(e,n){if(e.name===n)return e;if("children"in e)for(const t of e.children){const e=o(t,n);if(e)return e}return null}function r(n,t){return e(this,void 0,void 0,(function*(){try{yield figma.loadFontAsync(n.fontName),n.characters=t,console.log(`Set text: "${t}"`)}catch(e){throw console.error("Failed to set text content:",e),e}}))}function a(n,t){return e(this,void 0,void 0,(function*(){try{const e=yield figma.createImageAsync(t);if("RECTANGLE"===n.type||"FRAME"===n.type)n.fills=[{type:"IMAGE",imageHash:e.hash,scaleMode:"FILL"}];else if("INSTANCE"===n.type){const t=o(n,"Image placeholder")||o(n,"productImage");!t||"RECTANGLE"!==t.type&&"FRAME"!==t.type||(t.fills=[{type:"IMAGE",imageHash:e.hash,scaleMode:"FILL"}])}console.log(`Set image: ${t}`)}catch(e){throw console.error("Failed to set image fill:",e),e}}))}figma.showUI(__html__,{width:400,height:600}),figma.ui.onmessage=o=>e(void 0,void 0,void 0,(function*(){console.log("Received message:",o);try{switch(o.type){case"searchProducts":yield function(t){return e(this,void 0,void 0,(function*(){if(!(null==t?void 0:t.query))return void figma.ui.postMessage({type:"error",error:"Search query is required"});try{const e=yield n("\n    query SearchProducts($query: String!, $count: Int, $offset: Int) {\n      search(query: $query, count: $count, offset: $offset) {\n        pageInformation: info {\n          totalCount: total\n          pageNo: page\n          count\n        }\n        productItems: products {\n          id\n          baseProductId\n          title\n          brandName\n          shortDescription\n          defaultImageUrl\n          media {\n            defaultImage {\n              url\n              aspectRatio\n            }\n            images {\n              url\n              aspectRatio\n            }\n          }\n          isNew\n          price {\n            price: actual\n            unitPrice\n            unitOfMeasure\n          }\n          promotions {\n            promotionId: id\n            promotionType\n            startDate\n            endDate\n            offerText: description\n          }\n          reviews {\n            stats {\n              noOfReviews\n              overallRating\n              overallRatingRange\n            }\n          }\n        }\n      }\n    }\n  ",{query:t.query,count:t.count||20,offset:t.offset||0});figma.ui.postMessage({type:"searchProductsResponse",data:e})}catch(e){figma.ui.postMessage({type:"error",error:`Search failed: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(o.payload);break;case"getTaxonomy":yield function(){return e(this,void 0,void 0,(function*(){try{const e=yield n("\n    query TaxonomySuperDepts($storeId: ID, $style: String) {\n      taxonomy(storeId: $storeId) {\n        id\n        name\n        label\n        images(style: $style) {\n          style\n          images {\n            type\n            url\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n    }\n  ",{storeId:"3060",style:"rounded"});if(e.data&&e.data.taxonomy){const n=e.data.taxonomy.filter((e=>"superdepartment"===e.label||"TaxonomyItemType"===e.__typename));figma.ui.postMessage({type:"getTaxonomyResponse",data:Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{taxonomy:n})})})}else figma.ui.postMessage({type:"getTaxonomyResponse",data:e})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load categories: ${e instanceof Error?e.message:"Unknown error"}`})}}))}();break;case"getCategoryProducts":yield function(t){return e(this,void 0,void 0,(function*(){if(!(null==t?void 0:t.categoryId))return void figma.ui.postMessage({type:"error",error:"Category ID is required"});try{const e=yield n("\n    query GetCategoryProducts(\n      $facet: ID\n      $page: Int\n      $count: Int\n      $sortBy: String\n      $offset: Int\n      $superDepartment: String\n      $department: String\n      $aisle: String\n      $shelf: String\n      $offers: Boolean\n      $new: Boolean\n      $favourites: Boolean\n      $brand: String\n      $brands: [String]\n      $dietary: String\n      $categoryId: ID\n      $pageName: String\n    ) {\n      category(\n        page: $page\n        count: $count\n        sortBy: $sortBy\n        offset: $offset\n        facet: $facet\n        superDepartment: $superDepartment\n        department: $department\n        aisle: $aisle\n        shelf: $shelf\n        offers: $offers\n        new: $new\n        favourites: $favourites\n        brand: $brand\n        brands: $brands\n        dietary: $dietary\n        categoryId: $categoryId\n      ) {\n        pageInformation: info {\n          ...PageInformation\n        }\n        productItems: products {\n          ...ProductItem\n        }\n        facetLists: facetGroups {\n          ...FacetLists\n        }\n        options {\n          sortBy\n        }\n      }\n    }\n\n    fragment PageInformation on ListInfoInterface {\n      totalCount: total\n      pageNo: page\n      count\n      pageSize\n      offset\n    }\n\n    fragment ProductItem on ProductInterface {\n      id\n      baseProductId\n      title\n      brandName\n      shortDescription\n      defaultImageUrl\n      media {\n        defaultImage {\n          url\n          aspectRatio\n        }\n        images {\n          url\n          aspectRatio\n        }\n      }\n      badgeDetails(pageName: $pageName) {\n        badges\n        subText\n      }\n      superDepartmentId\n      superDepartmentName\n      departmentId\n      departmentName\n      aisleId\n      aisleName\n      shelfId\n      shelfName\n      displayType\n      productType\n      averageWeight\n      bulkBuyLimit\n      maxQuantityAllowed: bulkBuyLimit\n      groupBulkBuyLimit\n      bulkBuyLimitMessage\n      bulkBuyLimitGroupId\n      timeRestrictedDelivery\n      restrictedDelivery\n      isForSale\n      isNew\n      isRestrictedOrderAmendment\n      status\n      maxWeight\n      minWeight\n      increment\n      catchWeightList {\n        price\n        weight\n        default\n      }\n      restrictedDeliveryTime {\n        day\n        startDateTime\n        endDateTime\n        message\n      }\n      restrictedDeliveryDate {\n        startDate\n        endDate\n        leadTimeValue\n        message\n      }\n      price {\n        price: actual\n        unitPrice\n        unitOfMeasure\n      }\n      promotions {\n        promotionId: id\n        promotionType\n        startDate\n        endDate\n        offerText: description\n      }\n      reviews {\n        stats {\n          noOfReviews\n          overallRating\n          overallRatingRange\n        }\n      }\n    }\n\n    fragment FacetLists on ProductListFacetGroupInterface {\n      categoryId\n      category\n      facets {\n        facetId: id\n        facetName: name\n        binCount: count\n        isSelected: selected\n      }\n    }\n  ",{categoryId:t.categoryId,pageName:"browse",count:t.count||20,offset:t.offset||0});figma.ui.postMessage({type:"getCategoryProductsResponse",data:e})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load category products: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(o.payload);break;case"getCategoryChildren":yield function(t){return e(this,void 0,void 0,(function*(){if(!(null==t?void 0:t.categoryId))return void figma.ui.postMessage({type:"error",error:"Category ID is required"});try{const e=yield n("\n    query GetCategoryChildren($categoryId: String, $storeId: ID) {\n      taxonomy(storeId: $storeId, categoryId: $categoryId) {\n        id\n        name\n        label\n        pageType\n        images {\n          style\n          images {\n            type\n            url\n            __typename\n          }\n          __typename\n        }\n        children {\n          id\n          name\n          label\n          pageType\n          images {\n            style\n            images {\n              type\n              url\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n    }\n  ",{categoryId:t.categoryId,storeId:"3060"});figma.ui.postMessage({type:"getCategoryChildrenResponse",data:e})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load category children: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(o.payload);break;case"searchWithSuggestions":yield function(t){return e(this,void 0,void 0,(function*(){if(!(null==t?void 0:t.query))return void figma.ui.postMessage({type:"error",error:"Search query is required"});try{const e={query:t.query,suggestionsCount:t.suggestionsCount||10};console.log("Making search suggestions request with variables:",e);const o=yield n("\n    query SearchWithSuggestions(\n      $query: String!\n      $suggestionsCount: Int\n      $params: BrowseSearchConfig\n      $configs: [ConfigArgType]\n    ) {\n      search(\n        query: $query\n        config: $params\n        configs: $configs\n      ) {\n        suggestions(suggestionsCount: $suggestionsCount) {\n          searchTerms {\n            suggestionQuery\n          }\n          info {\n            count\n            query\n          }\n        }\n      }\n    }\n  ",e);console.log("Search suggestions API response:",o),figma.ui.postMessage({type:"searchWithSuggestionsResponse",data:o})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to search with suggestions: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(o.payload);break;case"loadRecentSearches":yield function(){return e(this,void 0,void 0,(function*(){try{const e=yield figma.clientStorage.getAsync("tesco-recent-searches");figma.ui.postMessage({type:"recentSearchesLoaded",data:e||[]})}catch(e){console.error("Failed to load recent searches:",e),figma.ui.postMessage({type:"recentSearchesLoaded",data:[]})}}))}();break;case"saveRecentSearches":yield function(n){return e(this,void 0,void 0,(function*(){try{(null==n?void 0:n.searches)&&(yield figma.clientStorage.setAsync("tesco-recent-searches",n.searches),console.log("Recent searches saved:",n.searches))}catch(e){console.error("Failed to save recent searches:",e)}}))}(o.payload);break;case"populateSelectedTiles":yield function(n){return e(this,void 0,void 0,(function*(){if(console.log("ð¯ Starting tile population process"),(null==n?void 0:n.products)&&0!==n.products.length)try{const e=figma.currentPage.selection;if(0===e.length)return void figma.ui.postMessage({type:"error",error:"Please select some tiles/components to populate"});const o=function(e){const n=[];function t(e){if(function(e){if("FRAME"===e.type||"COMPONENT"===e.type||"INSTANCE"===e.type){const n=e.name.toLowerCase();return n.includes("product")||n.includes("tile")||n.includes("card")||n.includes("item")}if("GROUP"===e.type){const n=e.name.toLowerCase();return n.includes("product")||n.includes("tile")||n.includes("card")||n.includes("item")}return!1}(e)&&(n.push(e),console.log(`Found product tile: ${e.name} (${e.type})`)),"children"in e&&e.children)for(const n of e.children)t(n)}for(const n of e)t(n);return n}(e);if(0===o.length)return void figma.ui.postMessage({type:"error",error:"No product tiles found in selection. Please select frames containing product tiles."});console.log(`Found ${o.length} product tiles in ${e.length} selected nodes`),console.log(`Available products: ${n.products.length}`);let r=0;const a=[];for(let e=0;e<o.length&&e<n.products.length;e++){const s=o[e],i=n.products[e];try{yield t(s,i),r++,console.log(`â Populated tile ${e+1} with product: ${i.title}`)}catch(n){const t=`Failed to populate tile ${e+1}: ${n instanceof Error?n.message:"Unknown error"}`;a.push(t),console.error(t)}}figma.ui.postMessage({type:"populateComplete",success:!0,populatedCount:r,totalSelected:o.length,errors:a.length>0?a:void 0}),console.log(`ð Population complete: ${r}/${o.length} tiles populated`)}catch(e){figma.ui.postMessage({type:"error",error:`Failed to populate tiles: ${e instanceof Error?e.message:"Unknown error"}`})}else figma.ui.postMessage({type:"error",error:"No products provided for population"})}))}(o.payload);break;default:figma.ui.postMessage({type:"error",error:"Unknown message type"})}}catch(e){console.error("Plugin error:",e),figma.ui.postMessage({type:"error",error:e instanceof Error?e.message:"Unknown error"})}}))}})[383]()})();