(()=>{"use strict";const e={"app-grid":{platform:"app",layout:"grid",componentId:"",libraryName:"Library 1",libraryId:""},"app-vertical":{platform:"app",layout:"vertical",componentId:"",libraryName:"Library 1",libraryId:""},"app-horizontal":{platform:"app",layout:"horizontal",componentId:"",libraryName:"Library 1",libraryId:""},"mobile-web-grid":{platform:"mobile-web",layout:"grid",componentId:"",libraryName:"Library 1",libraryId:""},"mobile-web-vertical":{platform:"mobile-web",layout:"vertical",componentId:"",libraryName:"Library 1",libraryId:""},"mobile-web-horizontal":{platform:"mobile-web",layout:"horizontal",componentId:"",libraryName:"Library 1",libraryId:""},"desktop-web-grid":{platform:"desktop-web",layout:"grid",componentId:"",libraryName:"Library 2",libraryId:""},"desktop-web-vertical":{platform:"desktop-web",layout:"vertical",componentId:"",libraryName:"Library 2",libraryId:""},"desktop-web-horizontal":{platform:"desktop-web",layout:"horizontal",componentId:"",libraryName:"Library 2",libraryId:""}},n={grid:{layoutMode:"HORIZONTAL",layoutWrap:"WRAP"},vertical:{layoutMode:"VERTICAL",layoutWrap:"NO_WRAP"},horizontal:{layoutMode:"HORIZONTAL",layoutWrap:"NO_WRAP"}};var t=function(e,n,t,o){return new(t||(t=Promise))((function(r,a){function i(e){try{c(o.next(e))}catch(e){a(e)}}function s(e){try{c(o.throw(e))}catch(e){a(e)}}function c(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(i,s)}c((o=o.apply(e,n||[])).next())}))};function o(e){return t(this,arguments,void 0,(function*(e,n={}){const t=yield fetch("https://origin-preview1-mango.omnichannel.tescocloud.com/api",{method:"POST",headers:{"Content-Type":"application/json",Region:"UK"},body:JSON.stringify({query:e,variables:n})});if(!t.ok)throw new Error(`API request failed with status ${t.status}`);return t.json()}))}function r(o,r,s,c,l){return t(this,void 0,void 0,(function*(){const d=e[`${s}-${c}`];if(!d||!d.componentId)throw new Error(`No component configured for ${s} ${c}`);let p;const u=d.componentId.length>20&&/^[a-f0-9]+$/i.test(d.componentId);if(d.libraryId&&d.libraryId.length>0||u)try{p=yield figma.importComponentByKeyAsync(d.componentId)}catch(e){throw new Error(`Failed to import library component: ${d.componentId}. Make sure the library is published and accessible.`)}else{const e=yield figma.getNodeByIdAsync(d.componentId);if(!e||"COMPONENT"!==e.type)throw new Error(`Local component not found: ${d.componentId}`);p=e}yield function(e){return t(this,void 0,void 0,(function*(){const n=new Set;a(e,n);const t=Array.from(n).map((e=>{const[n,t]=e.split(":");return figma.loadFontAsync({family:n,style:t})}));try{yield Promise.all(t),console.log(`Preloaded ${n.size} fonts from component`)}catch(e){console.warn("Some fonts failed to load:",e)}}))}(p);const m=n[c];o.layoutMode=m.layoutMode,o.layoutWrap=m.layoutWrap,o.primaryAxisSizingMode="AUTO",o.counterAxisSizingMode="AUTO",o.itemSpacing=16,o.paddingLeft=16,o.paddingRight=16,o.paddingTop=16,o.paddingBottom=16;const y=r.slice(0,l);let g=0;for(const e of y){const n=p.createInstance();o.appendChild(n),yield i(n,e),g++}figma.ui.postMessage({type:"populateComplete",success:!0,populatedCount:g,totalSelected:g})}))}function a(e,n){if("TEXT"===e.type&&"object"==typeof e.fontName&&null!==e.fontName&&n.add(`${e.fontName.family}:${e.fontName.style}`),"children"in e&&e.children)for(const t of e.children)a(t,n)}function i(e,n){return t(this,void 0,void 0,(function*(){var t,o,r,a,i;console.log(`Populating node: ${e.name} with product: ${n.title}`);if(n.title){const t=s(e,"productName");t&&"TEXT"===t.type&&(yield c(t,n.title))}if(null===(t=n.price)||void 0===t?void 0:t.price){const t=s(e,"productPrice");if(t&&"TEXT"===t.type){const e=`Â£${n.price.price.toFixed(2)}`;yield c(t,e)}}if(n.promotions&&n.promotions.length>0){const t=s(e,"offerText");t&&"TEXT"===t.type&&(yield c(t,n.promotions[0].offerText||"Special Offer"))}if(n.defaultImageUrl||(null===(r=null===(o=n.media)||void 0===o?void 0:o.defaultImage)||void 0===r?void 0:r.url)){const t=n.defaultImageUrl||n.media.defaultImage.url,o=s(e,"productImage");!o||"RECTANGLE"!==o.type&&"FRAME"!==o.type||(yield l(o,t))}const d=s(e,"Thumbnail");if(d&&"INSTANCE"===d.type)try{if(n.defaultImageUrl||(null===(i=null===(a=n.media)||void 0===a?void 0:a.defaultImage)||void 0===i?void 0:i.url)){const e=n.defaultImageUrl||n.media.defaultImage.url;yield l(d,e)}}catch(e){console.log("Could not set thumbnail image:",e)}}))}function s(e,n){if(e.name===n)return e;if("children"in e)for(const t of e.children){const e=s(t,n);if(e)return e}return null}function c(e,n){return t(this,void 0,void 0,(function*(){try{yield figma.loadFontAsync(e.fontName),e.characters=n,console.log(`Set text: "${n}"`)}catch(e){throw console.error("Failed to set text content:",e),e}}))}function l(e,n){return t(this,void 0,void 0,(function*(){try{const t=yield figma.createImageAsync(n);if("RECTANGLE"===e.type||"FRAME"===e.type)e.fills=[{type:"IMAGE",imageHash:t.hash,scaleMode:"FILL"}];else if("INSTANCE"===e.type){const n=s(e,"Image placeholder")||s(e,"productImage");!n||"RECTANGLE"!==n.type&&"FRAME"!==n.type||(n.fills=[{type:"IMAGE",imageHash:t.hash,scaleMode:"FILL"}])}console.log(`Set image: ${n}`)}catch(e){throw console.error("Failed to set image fill:",e),e}}))}figma.showUI(__html__,{width:400,height:600}),figma.ui.onmessage=n=>t(void 0,void 0,void 0,(function*(){console.log("Received message:",n);try{switch(n.type){case"searchProducts":yield function(e){return t(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.query))return void figma.ui.postMessage({type:"error",error:"Search query is required"});try{const n=yield o("\n    query SearchProducts($query: String!, $count: Int, $offset: Int) {\n      search(query: $query, count: $count, offset: $offset) {\n        pageInformation: info {\n          totalCount: total\n          pageNo: page\n          count\n        }\n        productItems: products {\n          id\n          baseProductId\n          title\n          brandName\n          shortDescription\n          defaultImageUrl\n          media {\n            defaultImage {\n              url\n              aspectRatio\n            }\n            images {\n              url\n              aspectRatio\n            }\n          }\n          isNew\n          price {\n            price: actual\n            unitPrice\n            unitOfMeasure\n          }\n          promotions {\n            promotionId: id\n            promotionType\n            startDate\n            endDate\n            offerText: description\n          }\n          reviews {\n            stats {\n              noOfReviews\n              overallRating\n              overallRatingRange\n            }\n          }\n        }\n      }\n    }\n  ",{query:e.query,count:e.count||20,offset:e.offset||0});figma.ui.postMessage({type:"searchProductsResponse",data:n})}catch(e){figma.ui.postMessage({type:"error",error:`Search failed: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(n.payload);break;case"getTaxonomy":yield function(){return t(this,void 0,void 0,(function*(){try{const e=yield o("\n    query TaxonomySuperDepts($storeId: ID, $style: String) {\n      taxonomy(storeId: $storeId) {\n        id\n        name\n        label\n        images(style: $style) {\n          style\n          images {\n            type\n            url\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n    }\n  ",{storeId:"3060",style:"rounded"});if(e.data&&e.data.taxonomy){const n=e.data.taxonomy.filter((e=>"superdepartment"===e.label||"TaxonomyItemType"===e.__typename));figma.ui.postMessage({type:"getTaxonomyResponse",data:Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{taxonomy:n})})})}else figma.ui.postMessage({type:"getTaxonomyResponse",data:e})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load categories: ${e instanceof Error?e.message:"Unknown error"}`})}}))}();break;case"getCategoryProducts":yield function(e){return t(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.categoryId))return void figma.ui.postMessage({type:"error",error:"Category ID is required"});try{const n=yield o("\n    query GetCategoryProducts(\n      $facet: ID\n      $page: Int\n      $count: Int\n      $sortBy: String\n      $offset: Int\n      $superDepartment: String\n      $department: String\n      $aisle: String\n      $shelf: String\n      $offers: Boolean\n      $new: Boolean\n      $favourites: Boolean\n      $brand: String\n      $brands: [String]\n      $dietary: String\n      $categoryId: ID\n      $pageName: String\n    ) {\n      category(\n        page: $page\n        count: $count\n        sortBy: $sortBy\n        offset: $offset\n        facet: $facet\n        superDepartment: $superDepartment\n        department: $department\n        aisle: $aisle\n        shelf: $shelf\n        offers: $offers\n        new: $new\n        favourites: $favourites\n        brand: $brand\n        brands: $brands\n        dietary: $dietary\n        categoryId: $categoryId\n      ) {\n        pageInformation: info {\n          ...PageInformation\n        }\n        productItems: products {\n          ...ProductItem\n        }\n        facetLists: facetGroups {\n          ...FacetLists\n        }\n        options {\n          sortBy\n        }\n      }\n    }\n\n    fragment PageInformation on ListInfoInterface {\n      totalCount: total\n      pageNo: page\n      count\n      pageSize\n      offset\n    }\n\n    fragment ProductItem on ProductInterface {\n      id\n      baseProductId\n      title\n      brandName\n      shortDescription\n      defaultImageUrl\n      media {\n        defaultImage {\n          url\n          aspectRatio\n        }\n        images {\n          url\n          aspectRatio\n        }\n      }\n      badgeDetails(pageName: $pageName) {\n        badges\n        subText\n      }\n      superDepartmentId\n      superDepartmentName\n      departmentId\n      departmentName\n      aisleId\n      aisleName\n      shelfId\n      shelfName\n      displayType\n      productType\n      averageWeight\n      bulkBuyLimit\n      maxQuantityAllowed: bulkBuyLimit\n      groupBulkBuyLimit\n      bulkBuyLimitMessage\n      bulkBuyLimitGroupId\n      timeRestrictedDelivery\n      restrictedDelivery\n      isForSale\n      isNew\n      isRestrictedOrderAmendment\n      status\n      maxWeight\n      minWeight\n      increment\n      catchWeightList {\n        price\n        weight\n        default\n      }\n      restrictedDeliveryTime {\n        day\n        startDateTime\n        endDateTime\n        message\n      }\n      restrictedDeliveryDate {\n        startDate\n        endDate\n        leadTimeValue\n        message\n      }\n      price {\n        price: actual\n        unitPrice\n        unitOfMeasure\n      }\n      promotions {\n        promotionId: id\n        promotionType\n        startDate\n        endDate\n        offerText: description\n      }\n      reviews {\n        stats {\n          noOfReviews\n          overallRating\n          overallRatingRange\n        }\n      }\n    }\n\n    fragment FacetLists on ProductListFacetGroupInterface {\n      categoryId\n      category\n      facets {\n        facetId: id\n        facetName: name\n        binCount: count\n        isSelected: selected\n      }\n    }\n  ",{categoryId:e.categoryId,pageName:"browse",count:e.count||20,offset:e.offset||0});figma.ui.postMessage({type:"getCategoryProductsResponse",data:n})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load category products: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(n.payload);break;case"getCategoryChildren":yield function(e){return t(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.categoryId))return void figma.ui.postMessage({type:"error",error:"Category ID is required"});try{const n=yield o("\n    query GetCategoryChildren($categoryId: String, $storeId: ID) {\n      taxonomy(storeId: $storeId, categoryId: $categoryId) {\n        id\n        name\n        label\n        pageType\n        images {\n          style\n          images {\n            type\n            url\n            __typename\n          }\n          __typename\n        }\n        children {\n          id\n          name\n          label\n          pageType\n          images {\n            style\n            images {\n              type\n              url\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n    }\n  ",{categoryId:e.categoryId,storeId:"3060"});figma.ui.postMessage({type:"getCategoryChildrenResponse",data:n})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load category children: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(n.payload);break;case"searchWithSuggestions":yield function(e){return t(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.query))return void figma.ui.postMessage({type:"error",error:"Search query is required"});try{const n={query:e.query,suggestionsCount:e.suggestionsCount||10};console.log("Making search suggestions request with variables:",n);const t=yield o("\n    query SearchWithSuggestions(\n      $query: String!\n      $suggestionsCount: Int\n      $params: BrowseSearchConfig\n      $configs: [ConfigArgType]\n    ) {\n      search(\n        query: $query\n        config: $params\n        configs: $configs\n      ) {\n        suggestions(suggestionsCount: $suggestionsCount) {\n          searchTerms {\n            suggestionQuery\n          }\n          info {\n            count\n            query\n          }\n        }\n      }\n    }\n  ",n);console.log("Search suggestions API response:",t),figma.ui.postMessage({type:"searchWithSuggestionsResponse",data:t})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to search with suggestions: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(n.payload);break;case"loadRecentSearches":yield function(){return t(this,void 0,void 0,(function*(){try{const e=yield figma.clientStorage.getAsync("tesco-recent-searches");figma.ui.postMessage({type:"recentSearchesLoaded",data:e||[]})}catch(e){console.error("Failed to load recent searches:",e),figma.ui.postMessage({type:"recentSearchesLoaded",data:[]})}}))}();break;case"saveRecentSearches":yield function(e){return t(this,void 0,void 0,(function*(){try{(null==e?void 0:e.searches)&&(yield figma.clientStorage.setAsync("tesco-recent-searches",e.searches),console.log("Recent searches saved:",e.searches))}catch(e){console.error("Failed to save recent searches:",e)}}))}(n.payload);break;case"populateSelectedTiles":yield function(e){return t(this,void 0,void 0,(function*(){var n,o;if(console.log("Starting population with config:",{platform:null==e?void 0:e.platform,layout:null==e?void 0:e.layout}),(null==e?void 0:e.products)&&0!==e.products.length)try{const s=figma.currentPage.selection,c=function(e){const n=[];function t(e){if(function(e){if("FRAME"===e.type||"COMPONENT"===e.type||"INSTANCE"===e.type){const n=e.name.toLowerCase();return n.includes("product")||n.includes("tile")||n.includes("card")||n.includes("item")}if("GROUP"===e.type){const n=e.name.toLowerCase();return n.includes("product")||n.includes("tile")||n.includes("card")||n.includes("item")}return!1}(e)&&(n.push(e),console.log(`Found product tile: ${e.name} (${e.type})`)),"children"in e&&e.children)for(const n of e.children)t(n)}for(const n of e)t(n);return n}(s);c.length>0?yield function(e,n){return t(this,void 0,void 0,(function*(){let t=0;const o=[],r=new Set;for(const n of e)a(n,r);const s=Array.from(r).map((e=>{const[n,t]=e.split(":");return figma.loadFontAsync({family:n,style:t})}));try{yield Promise.all(s),console.log(`Preloaded ${r.size} fonts for existing tiles`)}catch(e){console.warn("Some fonts failed to load:",e)}for(let r=0;r<e.length&&r<n.length;r++)try{yield i(e[r],n[r]),t++}catch(e){o.push(`Tile ${r+1}: ${e instanceof Error?e.message:"Unknown error"}`)}figma.ui.postMessage({type:"populateComplete",success:!0,populatedCount:t,totalSelected:e.length,errors:o.length>0?o:void 0})}))}(c,e.products):1===s.length&&"FRAME"===s[0].type?yield r(s[0],e.products,e.platform||"app",e.layout||"grid",(null===(n=e.selectedProducts)||void 0===n?void 0:n.length)||e.products.length):yield function(e,n,o,a){return t(this,void 0,void 0,(function*(){const t=figma.createFrame();t.name=`${n} - ${o} - Product Grid`,t.x=figma.viewport.center.x-200,t.y=figma.viewport.center.y-200,figma.currentPage.appendChild(t),figma.currentPage.selection=[t],yield r(t,e,n,o,a)}))}(e.products,e.platform||"app",e.layout||"grid",(null===(o=e.selectedProducts)||void 0===o?void 0:o.length)||e.products.length)}catch(e){figma.ui.postMessage({type:"error",error:e instanceof Error?e.message:"Population failed"})}else figma.ui.postMessage({type:"error",error:"No products provided"})}))}(n.payload);break;case"saveComponentMapping":yield function(n){return t(this,void 0,void 0,(function*(){if(!(null==n?void 0:n.platform)||!(null==n?void 0:n.layout)||!(null==n?void 0:n.componentId))return void figma.ui.postMessage({type:"error",error:"Missing required parameters for component mapping"});const t=`${n.platform}-${n.layout}`;e[t]&&(e[t].componentId=n.componentId,e[t].libraryId=n.libraryId||"",e[t].libraryName=n.libraryName||"",yield figma.clientStorage.setAsync("component-mappings",e),figma.ui.postMessage({type:"componentMappingSaved",success:!0,key:t,componentId:n.componentId,libraryId:n.libraryId,libraryName:n.libraryName}))}))}(n.payload);break;case"getSelectedComponentId":yield function(){return t(this,void 0,void 0,(function*(){var e,n,t,o;const r=figma.currentPage.selection;if(0===r.length)return void figma.ui.postMessage({type:"error",error:"Please select a component first"});const a=r[0];if("COMPONENT"!==a.type&&"INSTANCE"!==a.type)return void figma.ui.postMessage({type:"error",error:"Please select a component or component instance"});let i,s,c;if("INSTANCE"===a.type){const t=a.mainComponent;if(!t)return void figma.ui.postMessage({type:"error",error:"Could not find main component for instance"});void 0!==t.remote?(i=t.key,s=null===(e=t.remote)||void 0===e?void 0:e.key,c=null===(n=t.remote)||void 0===n?void 0:n.name):(i=t.id,s=void 0,c=void 0)}else void 0!==a.remote?(i=a.key,s=null===(t=a.remote)||void 0===t?void 0:t.key,c=null===(o=a.remote)||void 0===o?void 0:o.name):(i=a.id,s=void 0,c=void 0);figma.ui.postMessage({type:"selectedComponentId",componentId:i,componentName:a.name,libraryId:s,libraryName:c})}))}();break;case"loadComponentMappings":yield function(){return t(this,void 0,void 0,(function*(){try{const n=yield figma.clientStorage.getAsync("component-mappings");n&&Object.assign(e,n),figma.ui.postMessage({type:"componentMappingsLoaded",mappings:e})}catch(e){console.error("Failed to load component mappings:",e)}}))}();break;case"extractMappings":yield function(){return t(this,void 0,void 0,(function*(){try{const n=figma.currentPage.selection;if(0===n.length)return void figma.ui.postMessage({type:"error",error:'Please select frames to scan for component instances (name them like: "app-grid", "mobile-web-vertical", etc.)'});const o={};let r=0;for(const a of n){if("FRAME"!==a.type)continue;const i=a.name.toLowerCase();function s(n){return t(this,void 0,void 0,(function*(){if(n.children)for(const t of n.children){if("INSTANCE"===t.type)try{const n=yield t.getMainComponentAsync();if(n){let t=n.id,a="",s="Local Components";if(n.key){t=n.key;const e=n.key.split(":");2===e.length&&(a=e[0],s="Imported Library")}for(const c in e)if(i.includes(c)||i.includes(c.replace("-"," "))){o[c]={componentId:t,libraryId:a,libraryName:s,componentName:n.name},r++,console.log(`Found mapping for ${c}: ${t} (libraryId: ${a})`);break}}}catch(e){console.warn("Failed to get main component:",e)}"FRAME"===t.type&&(yield s(t))}}))}yield s(a)}if(0===r)return void figma.ui.postMessage({type:"error",error:'No component instances found. Make sure your frames contain component instances and are named like: "app-grid", "mobile-web-vertical", etc.'});figma.ui.postMessage({type:"extractedMappings",mappings:o,foundCount:r})}catch(c){figma.ui.postMessage({type:"error",error:`Failed to extract mappings: ${c instanceof Error?c.message:"Unknown error"}`})}}))}();break;default:figma.ui.postMessage({type:"error",error:"Unknown message type"})}}catch(e){console.error("Plugin error:",e),figma.ui.postMessage({type:"error",error:e instanceof Error?e.message:"Unknown error"})}}))})();