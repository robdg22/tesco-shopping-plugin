(()=>{"use strict";const e=Object.assign({},{"app-grid":{platform:"app",layout:"grid",componentId:"460285c805ef3d57d4777ada2d578eb344acfb8a",libraryName:"DDS Shopping native domain library",libraryId:"460285c805ef3d57d4777ada2d578eb344acfb8a"},"app-vertical":{platform:"app",layout:"vertical",componentId:"d32bcf2b8ce4db5afa4b2a718a60c2075009b715",libraryName:"DDS Shopping native domain library",libraryId:"d32bcf2b8ce4db5afa4b2a718a60c2075009b715"},"app-horizontal":{platform:"app",layout:"horizontal",componentId:"004c06075c5e082faaab349559abedfb86229e3a",libraryName:"DDS Shopping native domain library",libraryId:"004c06075c5e082faaab349559abedfb86229e3a"},"mobile-web-grid":{platform:"mobile-web",layout:"grid",componentId:"ca2dca0f0925c9184a3d0d85e5662cf6db83efd9",libraryName:"DDS Shopping web domain library",libraryId:"ca2dca0f0925c9184a3d0d85e5662cf6db83efd9"},"mobile-web-vertical":{platform:"mobile-web",layout:"vertical",componentId:"bfd125dd00b542b4e21d2dfb9980ed5584fc8fb6",libraryName:"DDS Shopping web domain library",libraryId:"bfd125dd00b542b4e21d2dfb9980ed5584fc8fb6"},"mobile-web-horizontal":{platform:"mobile-web",layout:"horizontal",componentId:"8612136a8ee1b7f167ad984028c614c3f5ee139a",libraryName:"DDS Shopping web domain library",libraryId:"8612136a8ee1b7f167ad984028c614c3f5ee139a"},"desktop-web-grid":{platform:"desktop-web",layout:"grid",componentId:"ca2dca0f0925c9184a3d0d85e5662cf6db83efd9",libraryName:"DDS Shopping web domain library",libraryId:"ca2dca0f0925c9184a3d0d85e5662cf6db83efd9"},"desktop-web-vertical":{platform:"desktop-web",layout:"vertical",componentId:"9a1fb3f66e66b08f80969d8d45a97bc7768c68ef",libraryName:"DDS Shopping web domain library",libraryId:"9a1fb3f66e66b08f80969d8d45a97bc7768c68ef"},"desktop-web-horizontal":{platform:"desktop-web",layout:"horizontal",componentId:"8612136a8ee1b7f167ad984028c614c3f5ee139a",libraryName:"DDS Shopping web domain library",libraryId:"8612136a8ee1b7f167ad984028c614c3f5ee139a"}}),n={grid:{layoutMode:"HORIZONTAL",layoutWrap:"WRAP"},vertical:{layoutMode:"VERTICAL",layoutWrap:"NO_WRAP"},horizontal:{layoutMode:"HORIZONTAL",layoutWrap:"NO_WRAP"}};var t=function(e,n,t,o){return new(t||(t=Promise))((function(r,a){function i(e){try{c(o.next(e))}catch(e){a(e)}}function s(e){try{c(o.throw(e))}catch(e){a(e)}}function c(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(i,s)}c((o=o.apply(e,n||[])).next())}))};function o(e){return t(this,arguments,void 0,(function*(e,n={}){const t=yield fetch("https://origin-preview1-mango.omnichannel.tescocloud.com/api",{method:"POST",headers:{"Content-Type":"application/json",Region:"UK"},body:JSON.stringify({query:e,variables:n})});if(!t.ok)throw new Error(`API request failed with status ${t.status}`);return t.json()}))}function r(o,r,s,c,d){return t(this,void 0,void 0,(function*(){const l=e[`${s}-${c}`];if(!l||!l.componentId)throw new Error(`No component configured for ${s} ${c}`);let p;const u=l.componentId.length>20&&/^[a-f0-9]+$/i.test(l.componentId);if(l.libraryId&&l.libraryId.length>0||u)try{console.log("Importing component with key:",l.componentId),p=yield figma.importComponentByKeyAsync(l.componentId)}catch(e){throw new Error(`Failed to import library component: ${l.componentId}. Make sure the library is published and accessible.`)}else{const e=yield figma.getNodeByIdAsync(l.componentId);if(!e||"COMPONENT"!==e.type)throw new Error(`Local component not found: ${l.componentId}`);p=e}yield function(e){return t(this,void 0,void 0,(function*(){const n=new Set;a(e,n);const t=Array.from(n).map((e=>{const[n,t]=e.split(":");return figma.loadFontAsync({family:n,style:t})}));try{yield Promise.all(t),console.log(`Preloaded ${n.size} fonts from component`)}catch(e){console.warn("Some fonts failed to load:",e)}}))}(p);const f=n[c];o.layoutMode=f.layoutMode,o.layoutWrap=f.layoutWrap,o.primaryAxisSizingMode="AUTO",o.counterAxisSizingMode="AUTO",o.itemSpacing=16,o.paddingLeft=16,o.paddingRight=16,o.paddingTop=16,o.paddingBottom=16;const g=r.slice(0,d);let m=0;for(const e of g){const n=p.createInstance();o.appendChild(n),yield i(n,e),m++}figma.ui.postMessage({type:"populateComplete",success:!0,populatedCount:m,totalSelected:m})}))}function a(e,n){if("TEXT"===e.type&&"object"==typeof e.fontName&&null!==e.fontName&&n.add(`${e.fontName.family}:${e.fontName.style}`),"children"in e&&e.children)for(const t of e.children)a(t,n)}function i(e,n){return t(this,void 0,void 0,(function*(){var t,o,r,a,i,l,p,u,f,g;console.log(`Populating node: ${e.name} with product: ${n.title}`);if(n.title){const t=s(e,"productName");t&&"TEXT"===t.type&&(yield c(t,n.title),t.visible=!0)}if(null===(t=n.price)||void 0===t?void 0:t.price){const t=s(e,"productPrice");if(t&&"TEXT"===t.type){const e=`£${n.price.price.toFixed(2)}`;yield c(t,e),t.visible=!0}}const m=s(e,"productPriceWeight");if(m&&"TEXT"===m.type){const e=(null===(o=n.price)||void 0===o?void 0:o.unitPrice)&&(null===(r=n.price)||void 0===r?void 0:r.unitOfMeasure),t="each"!==(null===(i=null===(a=n.price)||void 0===a?void 0:a.unitOfMeasure)||void 0===i?void 0:i.toLowerCase());if(e&&t){const e=`£${parseFloat(n.price.unitPrice).toFixed(2)}/${n.price.unitOfMeasure}`;yield c(m,e),m.visible=!0,console.log(`Set unit price: ${e}`)}else m.visible=!1,console.log(`Hiding unit price (unitOfMeasure: ${(null===(l=n.price)||void 0===l?void 0:l.unitOfMeasure)||"none"})`)}const y=n.promotions&&n.promotions.length>0,h=s(e,"offerText");h&&"TEXT"===h.type&&(y?(yield c(h,n.promotions[0].offerText||"Special Offer"),h.visible=!0):h.visible=!1);const b=s(e,"valueBar");if(b&&(b.visible=y,console.log(`Value bar visibility: ${y}`)),n.defaultImageUrl||(null===(u=null===(p=n.media)||void 0===p?void 0:p.defaultImage)||void 0===u?void 0:u.url)){const t=n.defaultImageUrl||n.media.defaultImage.url,o=s(e,"productImage");!o||"RECTANGLE"!==o.type&&"FRAME"!==o.type||(yield d(o,t),o.visible=!0)}const v=s(e,"Thumbnail");if(v&&"INSTANCE"===v.type)try{if(n.defaultImageUrl||(null===(g=null===(f=n.media)||void 0===f?void 0:f.defaultImage)||void 0===g?void 0:g.url)){const e=n.defaultImageUrl||n.media.defaultImage.url;yield d(v,e),v.visible=!0}}catch(e){console.log("Could not set thumbnail image:",e)}}))}function s(e,n){if(e.name===n)return e;if("children"in e)for(const t of e.children){const e=s(t,n);if(e)return e}return null}function c(e,n){return t(this,void 0,void 0,(function*(){try{yield figma.loadFontAsync(e.fontName),e.characters=n,console.log(`Set text: "${n}"`)}catch(e){throw console.error("Failed to set text content:",e),e}}))}function d(e,n){return t(this,void 0,void 0,(function*(){try{const t=yield figma.createImageAsync(n);if("RECTANGLE"===e.type||"FRAME"===e.type)e.fills=[{type:"IMAGE",imageHash:t.hash,scaleMode:"FILL"}];else if("INSTANCE"===e.type){const n=s(e,"Image placeholder")||s(e,"productImage");!n||"RECTANGLE"!==n.type&&"FRAME"!==n.type||(n.fills=[{type:"IMAGE",imageHash:t.hash,scaleMode:"FILL"}])}console.log(`Set image: ${n}`)}catch(e){throw console.error("Failed to set image fill:",e),e}}))}figma.showUI(__html__,{width:400,height:600}),figma.ui.onmessage=n=>t(void 0,void 0,void 0,(function*(){console.log("Received message:",n);try{switch(n.type){case"searchProducts":yield function(e){return t(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.query))return void figma.ui.postMessage({type:"error",error:"Search query is required"});try{const n=yield o("\n    query SearchProducts($query: String!, $count: Int, $offset: Int) {\n      search(query: $query, count: $count, offset: $offset) {\n        pageInformation: info {\n          totalCount: total\n          pageNo: page\n          count\n        }\n        productItems: products {\n          id\n          baseProductId\n          title\n          brandName\n          shortDescription\n          defaultImageUrl\n          media {\n            defaultImage {\n              url\n              aspectRatio\n            }\n            images {\n              url\n              aspectRatio\n            }\n          }\n          isNew\n          price {\n            price: actual\n            unitPrice\n            unitOfMeasure\n          }\n          promotions {\n            promotionId: id\n            promotionType\n            startDate\n            endDate\n            offerText: description\n          }\n          reviews {\n            stats {\n              noOfReviews\n              overallRating\n              overallRatingRange\n            }\n          }\n        }\n      }\n    }\n  ",{query:e.query,count:e.count||20,offset:e.offset||0});figma.ui.postMessage({type:"searchProductsResponse",data:n})}catch(e){figma.ui.postMessage({type:"error",error:`Search failed: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(n.payload);break;case"getTaxonomy":yield function(){return t(this,void 0,void 0,(function*(){try{const e=yield o("\n    query TaxonomySuperDepts($storeId: ID, $style: String) {\n      taxonomy(storeId: $storeId) {\n        id\n        name\n        label\n        images(style: $style) {\n          style\n          images {\n            type\n            url\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n    }\n  ",{storeId:"3060",style:"rounded"});if(e.data&&e.data.taxonomy){const n=e.data.taxonomy.filter((e=>"superdepartment"===e.label||"TaxonomyItemType"===e.__typename));figma.ui.postMessage({type:"getTaxonomyResponse",data:Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{taxonomy:n})})})}else figma.ui.postMessage({type:"getTaxonomyResponse",data:e})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load categories: ${e instanceof Error?e.message:"Unknown error"}`})}}))}();break;case"getCategoryProducts":yield function(e){return t(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.categoryId))return void figma.ui.postMessage({type:"error",error:"Category ID is required"});try{const n=yield o("\n    query GetCategoryProducts(\n      $facet: ID\n      $page: Int\n      $count: Int\n      $sortBy: String\n      $offset: Int\n      $superDepartment: String\n      $department: String\n      $aisle: String\n      $shelf: String\n      $offers: Boolean\n      $new: Boolean\n      $favourites: Boolean\n      $brand: String\n      $brands: [String]\n      $dietary: String\n      $categoryId: ID\n      $pageName: String\n    ) {\n      category(\n        page: $page\n        count: $count\n        sortBy: $sortBy\n        offset: $offset\n        facet: $facet\n        superDepartment: $superDepartment\n        department: $department\n        aisle: $aisle\n        shelf: $shelf\n        offers: $offers\n        new: $new\n        favourites: $favourites\n        brand: $brand\n        brands: $brands\n        dietary: $dietary\n        categoryId: $categoryId\n      ) {\n        pageInformation: info {\n          ...PageInformation\n        }\n        productItems: products {\n          ...ProductItem\n        }\n        facetLists: facetGroups {\n          ...FacetLists\n        }\n        options {\n          sortBy\n        }\n      }\n    }\n\n    fragment PageInformation on ListInfoInterface {\n      totalCount: total\n      pageNo: page\n      count\n      pageSize\n      offset\n    }\n\n    fragment ProductItem on ProductInterface {\n      id\n      baseProductId\n      title\n      brandName\n      shortDescription\n      defaultImageUrl\n      media {\n        defaultImage {\n          url\n          aspectRatio\n        }\n        images {\n          url\n          aspectRatio\n        }\n      }\n      badgeDetails(pageName: $pageName) {\n        badges\n        subText\n      }\n      superDepartmentId\n      superDepartmentName\n      departmentId\n      departmentName\n      aisleId\n      aisleName\n      shelfId\n      shelfName\n      displayType\n      productType\n      averageWeight\n      bulkBuyLimit\n      maxQuantityAllowed: bulkBuyLimit\n      groupBulkBuyLimit\n      bulkBuyLimitMessage\n      bulkBuyLimitGroupId\n      timeRestrictedDelivery\n      restrictedDelivery\n      isForSale\n      isNew\n      isRestrictedOrderAmendment\n      status\n      maxWeight\n      minWeight\n      increment\n      catchWeightList {\n        price\n        weight\n        default\n      }\n      restrictedDeliveryTime {\n        day\n        startDateTime\n        endDateTime\n        message\n      }\n      restrictedDeliveryDate {\n        startDate\n        endDate\n        leadTimeValue\n        message\n      }\n      price {\n        price: actual\n        unitPrice\n        unitOfMeasure\n      }\n      promotions {\n        promotionId: id\n        promotionType\n        startDate\n        endDate\n        offerText: description\n      }\n      reviews {\n        stats {\n          noOfReviews\n          overallRating\n          overallRatingRange\n        }\n      }\n    }\n\n    fragment FacetLists on ProductListFacetGroupInterface {\n      categoryId\n      category\n      facets {\n        facetId: id\n        facetName: name\n        binCount: count\n        isSelected: selected\n      }\n    }\n  ",{categoryId:e.categoryId,pageName:"browse",count:e.count||20,offset:e.offset||0});figma.ui.postMessage({type:"getCategoryProductsResponse",data:n})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load category products: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(n.payload);break;case"getCategoryChildren":yield function(e){return t(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.categoryId))return void figma.ui.postMessage({type:"error",error:"Category ID is required"});try{const n=yield o("\n    query GetCategoryChildren($categoryId: String, $storeId: ID) {\n      taxonomy(storeId: $storeId, categoryId: $categoryId) {\n        id\n        name\n        label\n        pageType\n        images {\n          style\n          images {\n            type\n            url\n            __typename\n          }\n          __typename\n        }\n        children {\n          id\n          name\n          label\n          pageType\n          images {\n            style\n            images {\n              type\n              url\n              __typename\n            }\n            __typename\n          }\n          __typename\n        }\n        __typename\n      }\n    }\n  ",{categoryId:e.categoryId,storeId:"3060"});figma.ui.postMessage({type:"getCategoryChildrenResponse",data:n})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to load category children: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(n.payload);break;case"searchWithSuggestions":yield function(e){return t(this,void 0,void 0,(function*(){if(!(null==e?void 0:e.query))return void figma.ui.postMessage({type:"error",error:"Search query is required"});try{const n={query:e.query,suggestionsCount:e.suggestionsCount||10};console.log("Making search suggestions request with variables:",n);const t=yield o("\n    query SearchWithSuggestions(\n      $query: String!\n      $suggestionsCount: Int\n      $params: BrowseSearchConfig\n      $configs: [ConfigArgType]\n    ) {\n      search(\n        query: $query\n        config: $params\n        configs: $configs\n      ) {\n        suggestions(suggestionsCount: $suggestionsCount) {\n          searchTerms {\n            suggestionQuery\n          }\n          info {\n            count\n            query\n          }\n        }\n      }\n    }\n  ",n);console.log("Search suggestions API response:",t),figma.ui.postMessage({type:"searchWithSuggestionsResponse",data:t})}catch(e){figma.ui.postMessage({type:"error",error:`Failed to search with suggestions: ${e instanceof Error?e.message:"Unknown error"}`})}}))}(n.payload);break;case"loadRecentSearches":yield function(){return t(this,void 0,void 0,(function*(){try{const e=yield figma.clientStorage.getAsync("tesco-recent-searches");figma.ui.postMessage({type:"recentSearchesLoaded",data:e||[]})}catch(e){console.error("Failed to load recent searches:",e),figma.ui.postMessage({type:"recentSearchesLoaded",data:[]})}}))}();break;case"saveRecentSearches":yield function(e){return t(this,void 0,void 0,(function*(){try{(null==e?void 0:e.searches)&&(yield figma.clientStorage.setAsync("tesco-recent-searches",e.searches),console.log("Recent searches saved:",e.searches))}catch(e){console.error("Failed to save recent searches:",e)}}))}(n.payload);break;case"populateSelectedTiles":yield function(e){return t(this,void 0,void 0,(function*(){var n;if(console.log("Starting population with config:",{platform:null==e?void 0:e.platform,layout:null==e?void 0:e.layout,totalProducts:null===(n=null==e?void 0:e.products)||void 0===n?void 0:n.length,selectedProductIds:null==e?void 0:e.selectedProducts}),!(null==e?void 0:e.products)||0===e.products.length)return void figma.ui.postMessage({type:"error",error:"No products provided"});let o=e.products;if(e.selectedProducts&&e.selectedProducts.length>0&&(o=e.products.filter((n=>e.selectedProducts.includes(n.id))),console.log(`Filtered to ${o.length} selected products from ${e.products.length} total`)),0!==o.length)try{const n=figma.currentPage.selection,s=function(e){const n=[];function t(e){if(function(e){if("FRAME"===e.type||"COMPONENT"===e.type||"INSTANCE"===e.type){const n=e.name.toLowerCase();return n.includes("product")||n.includes("tile")||n.includes("card")||n.includes("item")}if("GROUP"===e.type){const n=e.name.toLowerCase();return n.includes("product")||n.includes("tile")||n.includes("card")||n.includes("item")}return!1}(e)&&(n.push(e),console.log(`Found product tile: ${e.name} (${e.type})`)),"children"in e&&e.children)for(const n of e.children)t(n)}for(const n of e)t(n);return n}(n);s.length>0?yield function(e,n){return t(this,void 0,void 0,(function*(){let t=0;const o=[],r=new Set;for(const n of e)a(n,r);const s=Array.from(r).map((e=>{const[n,t]=e.split(":");return figma.loadFontAsync({family:n,style:t})}));try{yield Promise.all(s),console.log(`Preloaded ${r.size} fonts for existing tiles`)}catch(e){console.warn("Some fonts failed to load:",e)}for(let r=0;r<e.length;r++){const a=r%n.length;try{yield i(e[r],n[a]),t++}catch(e){o.push(`Tile ${r+1}: ${e instanceof Error?e.message:"Unknown error"}`)}}figma.ui.postMessage({type:"populateComplete",success:!0,populatedCount:t,totalSelected:e.length,errors:o.length>0?o:void 0})}))}(s,o):1===n.length&&"FRAME"===n[0].type?yield r(n[0],o,e.platform||"app",e.layout||"grid",o.length):yield function(e,n,o,a){return t(this,void 0,void 0,(function*(){const t=figma.createFrame();t.name=`${n} - ${o} - Product Grid`,t.x=figma.viewport.center.x-200,t.y=figma.viewport.center.y-200,figma.currentPage.appendChild(t),figma.currentPage.selection=[t],yield r(t,e,n,o,a)}))}(o,e.platform||"app",e.layout||"grid",o.length)}catch(e){figma.ui.postMessage({type:"error",error:e instanceof Error?e.message:"Population failed"})}else figma.ui.postMessage({type:"error",error:"No products to populate"})}))}(n.payload);break;case"saveComponentMapping":yield function(){return t(this,void 0,void 0,(function*(){figma.ui.postMessage({type:"error",error:"Component mappings are locked and cannot be modified. Contact your administrator to update default configurations."})}))}(n.payload);break;case"getSelectedComponentId":yield function(){return t(this,void 0,void 0,(function*(){var e,n,t,o;const r=figma.currentPage.selection;if(0===r.length)return void figma.ui.postMessage({type:"error",error:"Please select a component first"});const a=r[0];if("COMPONENT"!==a.type&&"INSTANCE"!==a.type)return void figma.ui.postMessage({type:"error",error:"Please select a component or component instance"});let i,s,c;if("INSTANCE"===a.type){const t=a.mainComponent;if(!t)return void figma.ui.postMessage({type:"error",error:"Could not find main component for instance"});void 0!==t.remote?(i=t.key,s=null===(e=t.remote)||void 0===e?void 0:e.key,c=null===(n=t.remote)||void 0===n?void 0:n.name):(i=t.id,s=void 0,c=void 0)}else void 0!==a.remote?(i=a.key,s=null===(t=a.remote)||void 0===t?void 0:t.key,c=null===(o=a.remote)||void 0===o?void 0:o.name):(i=a.id,s=void 0,c=void 0);figma.ui.postMessage({type:"selectedComponentId",componentId:i,componentName:a.name,libraryId:s,libraryName:c})}))}();break;case"loadComponentMappings":yield function(){return t(this,void 0,void 0,(function*(){try{figma.ui.postMessage({type:"componentMappingsLoaded",mappings:e})}catch(e){console.error("Failed to load component mappings:",e)}}))}();break;case"extractMappings":yield function(){return t(this,void 0,void 0,(function*(){try{const n=figma.currentPage.selection;if(0===n.length)return void figma.ui.postMessage({type:"error",error:'Please select frames to scan for component instances (name them like: "app-grid", "mobile-web-vertical", etc.)'});const o={};let r=0;for(const a of n){if("FRAME"!==a.type)continue;const i=a.name.toLowerCase();function s(n){return t(this,void 0,void 0,(function*(){if(n.children)for(const t of n.children){if("INSTANCE"===t.type)try{const n=yield t.getMainComponentAsync();if(n){let a="",s="",c="Local Components";console.log("Instance info:",{instanceComponentId:t.componentId,mainComponentId:n.id,mainComponentKey:n.key}),n.key?(a=n.key,s=n.key,c="Imported Library"):a=n.id;for(const t in e)if(i.includes(t)||i.includes(t.replace("-"," "))){o[t]={componentId:a,libraryId:s,libraryName:c,componentName:n.name},r++,console.log(`Found mapping for ${t}: ${a} (libraryId: ${s})`);break}}}catch(e){console.warn("Failed to get main component:",e)}"FRAME"===t.type&&(yield s(t))}}))}yield s(a)}if(0===r)return void figma.ui.postMessage({type:"error",error:'No component instances found. Make sure your frames contain component instances and are named like: "app-grid", "mobile-web-vertical", etc.'});figma.ui.postMessage({type:"extractedMappings",mappings:o,foundCount:r})}catch(c){figma.ui.postMessage({type:"error",error:`Failed to extract mappings: ${c instanceof Error?c.message:"Unknown error"}`})}}))}();break;default:figma.ui.postMessage({type:"error",error:"Unknown message type"})}}catch(e){console.error("Plugin error:",e),figma.ui.postMessage({type:"error",error:e instanceof Error?e.message:"Unknown error"})}}))})();